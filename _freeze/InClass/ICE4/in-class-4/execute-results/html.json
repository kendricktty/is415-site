{
  "hash": "a1f30031ae1157ab36386705ab50c83b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"CE4/H4: Spatial-Temporal Point Patterns Analysis\"\nsubtitle: \"In-class/Hands-On Exercise 4\"\nauthor: \"Kendrick Teo\"\ndate: \"2024-09-01\"\ndate-modified: \"last-modified\"\n\nexecute: \n  eval: true\n  echo: true\n  freeze: true\n---\n\n\n\n\n## CE4.1 Overview and explanation\n\nA spatio-temporal point process (also called space-time or spatial-temporal point process) is a random collection of points, where each point represents the time and location of an event. Examples of events include incidence of disease, sightings or births of a species, or the occurrences of fires, earthquakes, lightning strikes, tsunamis, or volcanic eruptions.\n\n**Spatio-temporal point patterns analysis (STPPA)** is becoming increasingly necessary, given the rapid emergence of geographically and temporally indexed data in a wide range of fields. Several spatio-temporal point patterns analysis methods have been introduced and implemented in R in the last ten years. Today's exercise will use data on a real-world forest fire event in *Kepulauan Bangka Belitung, Indonesia* from 1st January to 31st December 2023, to illustrate the methods, procedures and interpretations of STPPA.\n\nThis chapter shows how various R packages can be combined to run a set of spatio-temporal point pattern analyses in a guided and intuitive way. A real world forest fire event in  from 1st January 2023 to 31st December 2023 is used to illustrate the methods, procedures and interpretations.\n\n## CE4.2 Research questions\n\nBy the end of the exercise I hope to find out:\n\n- If the locations of forest fires in Kepulauan Bangka Belitung are spatially and spatially-temporally independent, and;\n- If not, where and when the observed forest fire locations tend to cluster.\n\n## CE4.3 The data\n\n- `forestfires`, a CSV file that provides locations on forest fires from Moderate Resolution Imaging Spectroradiometer (MODIS) sensor data.\n- `Kepulauan_Bangka_Belitung`, which as the name suggests marks the boundary of the region of Kepulauan Bangka Belitung.\n\n## CE4.4 New R Packages\n\nA new R package to be introduced today is `rgdal`, which is used for importing geospatial data in the GIS file format and saving it as a `Spatial*` DataFrame.\n\nIn addition, `sparr` gives us the ability to estimate fixed and adatptive kernel-smoothed spatial relative risk surfaces via the density-ratio method, and perform subsequent inferrence.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, raster, spatstat, tmap, tidyverse, sparr)\n```\n:::\n\n\n\n\n## CE4.5 Importing and preparing study area\n\n### CE4.5.1 Importing study area and creating OWIN object\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbb <- st_read(dsn=\"data/rawdata\", layer=\"Kepulauan_Bangka_Belitung\") %>%\n  st_union() %>%\n  st_zm(drop=TRUE, what=\"ZM\") %>% # Drop Z-values\n  st_transform(crs=32748) # EPSG: Indonesia\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Kepulauan_Bangka_Belitung' from data source \n  `/Users/kendricktty/Gits/SMU_CS/is415-site/InClass/ICE4/data/rawdata' \n  using driver `ESRI Shapefile'\nSimple feature collection with 298 features and 27 fields\nGeometry type: POLYGON\nDimension:     XYZ\nBounding box:  xmin: 105.1085 ymin: -3.116593 xmax: 106.8488 ymax: -1.501603\nz_range:       zmin: 0 zmax: 0\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nst_as_s2(): dropping Z and/or M coordinate\n```\n\n\n:::\n\n```{.r .cell-code}\n# This dataset keeps Z-dimension (height) data. We might want to remove it if we are to do KDE\nkbb_owin <- as.owin(kbb)\nkbb_owin\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nwindow: polygonal boundary\nenclosing rectangle: [512066.8, 705559.4] x [9655398, 9834006] units\n```\n\n\n:::\n:::\n\n\n\n\n## CE4.6 Importing and preparing forest fire data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Creating an SF dataframe from a CSV removes \"longitude\" and \"latitude\", transforming it to a \"geometry\" field\nfire_sf <- read_csv(\"data/rawdata/forestfires.csv\") %>% st_as_sf(coords=c(\"longitude\", \"latitude\"), crs=4326) %>% st_transform(crs=32748)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 741 Columns: 15\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr   (3): satellite, instrument, daynight\ndbl  (11): latitude, longitude, brightness, scan, track, acq_time, confidenc...\ndate  (1): acq_date\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\n\n\nWe will want to convert our SF object into `ppp`, which only accepts numerical or character data, later on. We will therefore need to convert our `acq_date` fields into numeric fields.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_sf <- fire_sf %>% mutate(DayOfYear=yday(acq_date)) %>%\n                      mutate(Month_num=month(acq_date)) %>%\n                      mutate(Month_fac=month(acq_date, label=TRUE, abbr=FALSE))\n```\n:::\n\n\n\n\n## CE4.7 Visualising fire locations\n\n### CE4.7.1 As points\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# tm_shape(kbb) + tm_polygons() + tm_shape(fire_sf) + tm_dots()\ntm_shape(kbb) + tm_polygons() + tm_shape(fire_sf) + tm_bubbles()\n```\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n### CE4.7.2 Over time\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(kbb) + tm_polygons() + tm_shape(fire_sf) + tm_dots(size=0.1) + tm_facets(by=\"Month_fac\", free.coords=FALSE, drop.units=TRUE)\n```\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# free.coords: All points have the same coordinate pairs\n```\n:::\n\n\n\n\n## CE4.8 Computing STKDE by Month\n\nUsing `sparttemp.density()` of the `sparr` package, we are able to compute **spatial-temporal KDE (STKDE)**.\n\n### CE4.8.1 Forest fires by month (`ppp`)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfire_month <- fire_sf %>% select(Month_num)\nfire_month_ppp <- as.ppp(fire_month)\nfire_month_ppp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern: 741 points\nmarks are numeric, of storage type  'double'\nwindow: rectangle = [521564.1, 695791] x [9658137, 9828767] units\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fire_month_ppp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern:  741 points\nAverage intensity 2.49258e-08 points per square unit\n\nCoordinates are given to 10 decimal places\n\nmarks are numeric, of type 'double'\nSummary:\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  1.000   8.000   9.000   8.579  10.000  12.000 \n\nWindow: rectangle = [521564.1, 695791] x [9658137, 9828767] units\n                    (174200 x 170600 units)\nWindow area = 29728200000 square units\n```\n\n\n:::\n\n```{.r .cell-code}\nany(duplicated(fire_month_ppp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] FALSE\n```\n\n\n:::\n\n```{.r .cell-code}\nfire_month_owin <- fire_month_ppp[kbb_owin]\nsummary(fire_month_owin)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMarked planar point pattern:  741 points\nAverage intensity 6.424519e-08 points per square unit\n\nCoordinates are given to 10 decimal places\n\nmarks are numeric, of type 'double'\nSummary:\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  1.000   8.000   9.000   8.579  10.000  12.000 \n\nWindow: polygonal boundary\n2 separate polygons (no holes)\n           vertices        area relative.area\npolygon 1     47493 11533600000      1.00e+00\npolygon 2       256      306427      2.66e-05\nenclosing rectangle: [512066.8, 705559.4] x [9655398, 9834006] units\n                     (193500 x 178600 units)\nWindow area = 11533900000 square units\nFraction of frame area: 0.334\n```\n\n\n:::\n:::\n\n\n\n\n### CE4.8.2 Spatio-temporal KDE\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_kde <- spattemp.density(fire_month_owin)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCalculating trivariate smooth...Done.\nEdge-correcting...Done.\nConditioning on time...Done.\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(st_kde)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatiotemporal Kernel Density Estimate\n\nBandwidths\n  h = 15102.47 (spatial)\n  lambda = 0.0304 (temporal)\n\nNo. of observations\n  741 \n\nSpatial bound\n  Type: polygonal\n  2D enclosure: [512066.8, 705559.4] x [9655398, 9834006]\n\nTemporal bound\n  [1, 12]\n\nEvaluation\n  128 x 128 x 12 trivariate lattice\n  Density range: [1.233458e-27, 8.202976e-10]\n```\n\n\n:::\n:::\n\n\n\n\n### CE4.8.3 Plotting the spatio-temporal KDE object\n\nThis code chunk `plot()`s the KDE for the entire year 2023. As expected, the KDEs indicate far fewer occurrences of forest fires in the area before June 2023 and in December 2023 (the rainy season usually falls between December and February.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# sparr\ntims <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)\npar(mfcol=c(1,2))\nfor (i in tims) {\n  plot(st_kde, i, override.par=FALSE, fix.range=TRUE, main=paste(\"KDE at month\", i))\n}\n```\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-5.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](in-class-4_files/figure-html/unnamed-chunk-9-6.png){width=672}\n:::\n:::",
    "supporting": [
      "in-class-4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}